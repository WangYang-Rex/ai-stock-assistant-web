{
  "swagger": "2.0",
  "info": {
    "title": "Strategies API",
    "version": "1.0.0",
    "description": "API for stock market strategies management and evaluation"
  },
  "consumes": [
    "application/json"
  ],
  "produces": [
    "application/json"
  ],
  "paths": {
    "/api/strategies/detail": {
      "post": {
        "tags": ["General"],
        "summary": "获取策略聚合详情",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": {
              "type": "object",
              "required": ["id"],
              "properties": {
                "id": { "type": "integer", "description": "策略ID" }
              }
            }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": { "$ref": "#/definitions/StrategyDetailDto" }
          }
        }
      }
    },
    "/api/strategies/signals/query": {
      "post": {
        "tags": ["Signals"],
        "summary": "分页查询策略信号",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": { "$ref": "#/definitions/QuerySignalDto" }
          }
        ],
        "responses": {
          "200": {
            "description": "信号列表",
            "schema": { "$ref": "#/definitions/SignalListResponseDto" }
          }
        }
      }
    },
    "/api/strategies/signals/latest": {
      "post": {
        "tags": ["Signals"],
        "summary": "获取最新策略信号",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": { "$ref": "#/definitions/LatestSignalDto" }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": {
              "type": "array",
              "items": { "$ref": "#/definitions/StrategySignal" }
            }
          }
        }
      }
    },
    "/api/strategies/signals/detail": {
      "post": {
        "tags": ["Signals"],
        "summary": "获取信号详情",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": {
              "type": "object",
              "required": ["id"],
              "properties": {
                "id": { "type": "integer", "description": "信号ID" }
              }
            }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": { "$ref": "#/definitions/StrategySignal" }
          }
        }
      }
    },
    "/api/strategies/close-auction/evaluate": {
      "post": {
        "tags": ["Close Auction"],
        "summary": "触发尾盘战法评估",
        "description": "传入标的代码，系统自动同步分时数据并计算尾盘买入信号",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": { "$ref": "#/definitions/EvaluateBySymbolDto" }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": { "$ref": "#/definitions/StrategySignalDto" }
          }
        }
      }
    },
    "/api/strategies/close-auction/backtest": {
      "post": {
        "tags": ["Close Auction"],
        "summary": "尾盘共振历史回测",
        "description": "对指定 ETF 进行历史共振得分计算及次日收益联动分析",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": {
              "type": "object",
              "required": ["etfCode", "dates"],
              "properties": {
                "etfCode": { "type": "string", "example": "588080" },
                "dates": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "回测日期列表 (YYYY-MM-DD)",
                  "example": ["2026-02-02", "2026-02-03"]
                }
              }
            }
          }
        ],
        "responses": {
          "200": {
            "description": "回测结果",
            "schema": { "$ref": "#/definitions/BacktestResultDto" }
          }
        }
      }
    },
    "/api/strategies/rule-trend/evaluate": {
      "post": {
        "tags": ["Rule Trend"],
        "summary": "触发规则趋势评估",
        "description": "传入股票代码，计算其趋势方向、风险状态及建议仓位动作",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": { "$ref": "#/definitions/EvaluateRuleTrendDto" }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": { "$ref": "#/definitions/EvaluationResult" }
          }
        }
      }
    },
    "/api/strategies/rule-trend/batch-evaluate": {
      "post": {
        "tags": ["Rule Trend"],
        "summary": "批量触发规则趋势评估",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "required": true,
            "schema": { "$ref": "#/definitions/EvaluateRuleTrendBatchDto" }
          }
        ],
        "responses": {
          "200": {
            "description": "成功",
            "schema": {
              "type": "array",
              "items": { "$ref": "#/definitions/EvaluationResult" }
            }
          }
        }
      }
    }
  },
  "definitions": {
    "StrategyDetailDto": {
      "type": "object",
      "properties": {
        "strategy": { "$ref": "#/definitions/StrategyInfoDto" },
        "metrics": { "$ref": "#/definitions/StrategyMetricsDto" },
        "priceSeries": {
          "type": "array",
          "items": { "$ref": "#/definitions/PricePointDto" }
        },
        "trades": {
          "type": "array",
          "items": { "$ref": "#/definitions/TradePointDto" }
        },
        "equityCurve": {
          "type": "array",
          "items": { "$ref": "#/definitions/EquityCurvePointDto" }
        }
      }
    },
    "StrategyInfoDto": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "code": { "type": "string" },
        "symbol": { "type": "string" },
        "status": { "type": "string" },
        "params": { "type": "object" }
      }
    },
    "StrategyMetricsDto": {
      "type": "object",
      "properties": {
        "totalReturn": { "type": "number" },
        "annualReturn": { "type": "number" },
        "maxDrawdown": { "type": "number" },
        "winRate": { "type": "number" },
        "tradeCount": { "type": "integer" }
      }
    },
    "PricePointDto": {
      "type": "object",
      "properties": {
        "date": { "type": "string" },
        "close": { "type": "number" }
      }
    },
    "TradePointDto": {
      "type": "object",
      "properties": {
        "date": { "type": "string" },
        "price": { "type": "number" },
        "side": { "type": "string", "enum": ["BUY", "SELL"] },
        "allow": { "type": "boolean" }
      }
    },
    "EquityCurvePointDto": {
      "type": "object",
      "properties": {
        "date": { "type": "string" },
        "equity": { "type": "number" }
      }
    },
    "QuerySignalDto": {
      "type": "object",
      "properties": {
        "strategyCode": { "type": "string" },
        "symbol": { "type": "string" },
        "startDate": { "type": "string" },
        "endDate": { "type": "string" },
        "allowOnly": { "type": "boolean" },
        "minConfidence": { "type": "number" },
        "page": { "type": "integer", "default": 1 },
        "pageSize": { "type": "integer", "default": 20 }
      }
    },
    "SignalListResponseDto": {
      "type": "object",
      "properties": {
        "list": {
          "type": "array",
          "items": { "$ref": "#/definitions/StrategySignal" }
        },
        "total": { "type": "integer" },
        "page": { "type": "integer" },
        "pageSize": { "type": "integer" }
      }
    },
    "LatestSignalDto": {
      "type": "object",
      "properties": {
        "limit": { "type": "integer", "default": 10 },
        "strategyCode": { "type": "string" },
        "symbol": { "type": "string" },
        "allowOnly": { "type": "boolean" }
      }
    },
    "StrategySignal": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "strategyCode": { "type": "string" },
        "symbol": { "type": "string" },
        "tradeDate": { "type": "string" },
        "allow": { "type": "integer" },
        "confidence": { "type": "integer" },
        "reasons": { "type": "array", "items": { "type": "string" } },
        "evalTime": { "type": "string", "format": "date-time" },
        "price": { "type": "number" },
        "vwap": { "type": "number" },
        "volume": { "type": "integer" },
        "extra": { "type": "object" }
      }
    },
    "EvaluateBySymbolDto": {
      "type": "object",
      "required": ["symbol"],
      "properties": {
        "symbol": { "type": "string", "example": "588080" },
        "market": { "type": "integer", "description": "1-SH, 0-SZ", "default": 1 }
      }
    },
    "StrategySignalDto": {
      "type": "object",
      "properties": {
        "strategy": { "type": "string" },
        "symbol": { "type": "string" },
        "allow": { "type": "boolean" },
        "confidence": { "type": "number" },
        "reasons": { "type": "array", "items": { "type": "string" } },
        "evaluatedAt": { "type": "string", "format": "date-time" }
      }
    },
    "EvaluateRuleTrendDto": {
      "type": "object",
      "required": ["code"],
      "properties": {
        "code": { "type": "string", "example": "000001" }
      }
    },
    "EvaluateRuleTrendBatchDto": {
      "type": "object",
      "required": ["codes"],
      "properties": {
        "codes": {
          "type": "array",
          "items": { "type": "string" },
          "example": ["000001", "600519"]
        }
      }
    },
    "EvaluationResult": {
      "type": "object",
      "properties": {
        "code": { "type": "string" },
        "success": { "type": "boolean" },
        "result": { "$ref": "#/definitions/TrendResult" },
        "risk": { "$ref": "#/definitions/RiskResult" },
        "position": { "$ref": "#/definitions/PositionResult" },
        "decision": { "$ref": "#/definitions/PositionDecision" },
        "message": { "type": "string" },
        "error": { "type": "string" }
      }
    },
    "TrendResult": {
      "type": "object",
      "properties": {
        "trend": { "type": "string", "enum": ["UP", "DOWN", "SIDEWAYS"] },
        "score": { "type": "number" },
        "strength": { "type": "string", "enum": ["WEAK", "MEDIUM", "STRONG"] },
        "reasons": { "type": "array", "items": { "type": "string" } },
        "snapshot": { "$ref": "#/definitions/TrendSnapshot" }
      }
    },
    "TrendSnapshot": {
      "type": "object",
      "properties": {
        "ma5": { "type": "number" },
        "ma10": { "type": "number" },
        "ma20": { "type": "number" },
        "ma60": { "type": "number" },
        "ema20": { "type": "number" },
        "ema20Slope": { "type": "number" },
        "macd": { "$ref": "#/definitions/MacdSnapshot" },
        "rsi": { "type": "number" },
        "volumeRatio": { "type": "number" },
        "price": { "type": "number" }
      }
    },
    "MacdSnapshot": {
      "type": "object",
      "properties": {
        "dif": { "type": "number" },
        "dea": { "type": "number" },
        "hist": { "type": "number" }
      }
    },
    "RiskResult": {
      "type": "object",
      "properties": {
        "shouldStop": { "type": "boolean" },
        "stopPrice": { "type": "number" },
        "reason": { "type": "string" },
        "snapshot": { "$ref": "#/definitions/RiskSnapshot" }
      }
    },
    "RiskSnapshot": {
      "type": "object",
      "properties": {
        "atr14": { "type": "number" },
        "ma10": { "type": "number" },
        "ma20": { "type": "number" }
      }
    },
    "PositionResult": {
      "type": "object",
      "properties": {
        "suggestedRatio": { "type": "number" },
        "action": {
          "type": "string",
          "enum": ["BUY", "SELL", "HOLD", "REDUCE", "NONE"]
        },
        "message": { "type": "string" }
      }
    },
    "PositionDecision": {
      "type": "object",
      "properties": {
        "action": { "type": "string", "enum": ["ADD", "REDUCE", "HOLD", "STOP"] },
        "percent": { "type": "number" },
        "reason": { "type": "string" }
      }
    },
    "ResonanceDetailDto": {
      "type": "object",
      "properties": {
        "directionConsistency": { "type": "number" },
        "weightedStrength": { "type": "number" },
        "syncRatio": { "type": "number" }
      }
    },
    "ResonanceScoreDto": {
      "type": "object",
      "properties": {
        "ts": { "type": "string" },
        "score": { "type": "integer" },
        "direction": { "type": "string", "enum": ["UP", "DOWN", "NEUTRAL"] },
        "detail": { "$ref": "#/definitions/ResonanceDetailDto" }
      }
    },
    "PerformanceDto": {
      "type": "object",
      "properties": {
        "nextOpenReturn": { "type": "number" },
        "nextHighReturn": { "type": "number" },
        "nextCloseReturn": { "type": "number" },
        "isSuccess": { "type": "boolean" }
      }
    },
    "BacktestDayDetailDto": {
      "type": "object",
      "properties": {
        "date": { "type": "string" },
        "resonance": { "$ref": "#/definitions/ResonanceScoreDto" },
        "performance": { "$ref": "#/definitions/PerformanceDto" }
      }
    },
    "BacktestResultDto": {
      "type": "object",
      "properties": {
        "etfCode": { "type": "string" },
        "startDate": { "type": "string" },
        "endDate": { "type": "string" },
        "totalDays": { "type": "integer" },
        "bullishDays": { "type": "integer" },
        "bearishDays": { "type": "integer" },
        "hitRate": { "type": "number" },
        "avgOpenReturn": { "type": "number" },
        "avgMaxReturn": { "type": "number" },
        "details": {
          "type": "array",
          "items": { "$ref": "#/definitions/BacktestDayDetailDto" }
        }
      }
    }
  }
}
